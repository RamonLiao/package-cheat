#!/bin/bash

################################################################################
# List All Packages - Simple package listing across all managers
#
# Author: Silent Alpha Project
# Version: 1.0.0
# License: MIT
#
# Description:
#   Simple script that lists all installed packages from all detected
#   package managers. Automatically skips managers that aren't installed.
#
# Usage:
#   list-all-packages           # List all packages
#   list-all-packages --help    # Show help
################################################################################

set -e

# ANSI color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
RESET='\033[0m'

# Script version
VERSION="1.0.0"

################################################################################
# Helper Functions
################################################################################

print_header() {
    echo ""
    echo -e "${BOLD}${CYAN}━━━ $1 ━━━${RESET}"
    echo ""
}

print_separator() {
    echo -e "${CYAN}────────────────────────────────────────────────────────${RESET}"
    echo ""
}

command_exists() {
    command -v "$1" >/dev/null 2>&1
}

get_version() {
    local pm=$1
    local version="unknown"

    case "$pm" in
        npm|pnpm|yarn|bun)
            version=$(${pm} --version 2>/dev/null || echo "unknown")
            ;;
        brew)
            version=$(brew --version 2>/dev/null | head -1 | awk '{print $2}' || echo "unknown")
            ;;
        port)
            version=$(port version 2>/dev/null | awk '{print $2}' || echo "unknown")
            ;;
        pip)
            version=$(pip --version 2>/dev/null | awk '{print $2}' || echo "unknown")
            ;;
        uv)
            version=$(uv --version 2>/dev/null | awk '{print $2}' || echo "unknown")
            ;;
        poetry)
            version=$(poetry --version 2>/dev/null | awk '{print $3}' || echo "unknown")
            ;;
        cargo)
            version=$(cargo --version 2>/dev/null | awk '{print $2}' || echo "unknown")
            ;;
        go)
            version=$(go version 2>/dev/null | awk '{print $3}' | sed 's/go//' || echo "unknown")
            ;;
        gem)
            version=$(gem --version 2>/dev/null || echo "unknown")
            ;;
    esac

    echo "$version"
}

list_packages() {
    local pm=$1
    local list_cmd=""

    # Determine the correct list command for each package manager
    case "$pm" in
        npm)
            list_cmd="npm list -g --depth=0"
            ;;
        pnpm)
            list_cmd="pnpm list -g"
            ;;
        yarn)
            list_cmd="yarn global list"
            ;;
        bun)
            list_cmd="bun pm ls -g"
            ;;
        brew)
            list_cmd="brew list"
            ;;
        port)
            list_cmd="port installed"
            ;;
        pip)
            list_cmd="pip list"
            ;;
        uv)
            list_cmd="uv pip list"
            ;;
        poetry)
            list_cmd="poetry show"
            ;;
        cargo)
            list_cmd="cargo install --list"
            ;;
        go)
            # Note: go list requires being in a module directory
            # For global binaries, we can list $GOPATH/bin contents
            if [[ -n "$GOPATH" ]]; then
                list_cmd="ls -1 $GOPATH/bin 2>/dev/null || echo 'No GOPATH set or no binaries found'"
            else
                echo -e "${YELLOW}⚠ GOPATH not set - cannot list Go binaries${RESET}"
                return 1
            fi
            ;;
        gem)
            list_cmd="gem list"
            ;;
        *)
            echo -e "${RED}✗ Unknown package manager: $pm${RESET}"
            return 1
            ;;
    esac

    # Execute the command
    set +e
    local output=$($list_cmd 2>&1)
    local exit_code=$?
    set -e

    if [[ $exit_code -eq 0 ]] && [[ -n "$output" ]]; then
        echo "$output"
        echo ""
        echo -e "${GREEN}✓ Listed successfully${RESET}"
    elif [[ -z "$output" ]]; then
        echo -e "${YELLOW}⚠ No packages installed${RESET}"
    else
        echo -e "${RED}✗ Command failed${RESET}"
        if [[ -n "$output" ]]; then
            echo "$output" | head -3
        fi
    fi
}

show_help() {
    echo -e "${BOLD}list-all-packages${RESET} - List all installed packages from all package managers"
    echo ""
    echo -e "${BOLD}USAGE:${RESET}"
    echo "  list-all-packages [OPTIONS]"
    echo ""
    echo -e "${BOLD}OPTIONS:${RESET}"
    echo "  -h, --help     Show this help message"
    echo "  -v, --version  Show version information"
    echo ""
    echo -e "${BOLD}DESCRIPTION:${RESET}"
    echo "  Automatically detects installed package managers and lists all"
    echo "  packages from each one. Skips package managers that aren't installed."
    echo ""
    echo -e "${BOLD}SUPPORTED PACKAGE MANAGERS:${RESET}"
    echo "  JavaScript/Node.js:  npm, pnpm, yarn, bun"
    echo "  macOS System:        brew, port"
    echo "  Python:              pip, uv, poetry"
    echo "  Other:               cargo (Rust), go (Go), gem (Ruby)"
    echo ""
    echo -e "${BOLD}EXAMPLES:${RESET}"
    echo "  list-all-packages              # List all packages"
    echo "  list-all-packages --help       # Show this help"
    echo ""
    echo -e "${BOLD}VERSION:${RESET}"
    echo "  $VERSION"
    echo ""
    echo -e "${BOLD}REPOSITORY:${RESET}"
    echo "  https://github.com/RamonLiao/package-cheat"
    echo ""
}

show_version() {
    echo "list-all-packages version $VERSION"
}

################################################################################
# Main Function
################################################################################

main() {
    # Parse arguments
    case "${1:-}" in
        -h|--help)
            show_help
            exit 0
            ;;
        -v|--version)
            show_version
            exit 0
            ;;
        "")
            # Continue with listing
            ;;
        *)
            echo -e "${RED}Error: Unknown option '$1'${RESET}"
            echo "Try 'list-all-packages --help' for more information."
            exit 1
            ;;
    esac

    # Define all package managers to check
    local all_managers=(npm pnpm yarn bun brew port pip uv poetry cargo go gem)
    local detected_count=0

    echo -e "${BOLD}${BLUE}═══════════════════════════════════════════════════════════════${RESET}"
    echo -e "${BOLD}${BLUE}  List All Installed Packages${RESET}"
    echo -e "${BOLD}${BLUE}═══════════════════════════════════════════════════════════════${RESET}"
    echo ""

    # Detect and list packages for each manager
    for pm in "${all_managers[@]}"; do
        if command_exists "$pm"; then
            local version=$(get_version "$pm")

            print_header "$pm ($version)"
            list_packages "$pm"
            print_separator

            ((detected_count++))
        fi
    done

    # Summary
    echo ""
    if [[ $detected_count -eq 0 ]]; then
        echo -e "${RED}✗ No package managers detected on this system!${RESET}"
        echo ""
        echo "Install at least one package manager to use this tool."
        exit 1
    else
        echo -e "${BOLD}${GREEN}✓ Complete!${RESET} Listed packages from $detected_count package manager(s)."
        echo ""
    fi
}

# Run main function
main "$@"
