#!/bin/bash

################################################################################
# Package Manager Cheatsheet - Interactive Command Reference
#
# Author: Silent Alpha Project
# Version: 1.0.0
# License: MIT
#
# Description:
#   Interactive bash script that detects installed package managers on macOS
#   and provides a comprehensive command reference with cheatsheets, comparison
#   views, search functionality, and markdown export.
#
# Supported Package Managers:
#   - JavaScript/Node.js: npm, pnpm, yarn, bun
#   - macOS System: brew, port
#   - Python: pip, uv, poetry
#   - Other: cargo (Rust), go (Go), gem (Ruby)
#
# Usage:
#   pkgcheat                # Launch interactive mode
#   pkgcheat npm            # Show npm cheatsheet
#   pkgcheat -l             # List detected managers
#   pkgcheat -s cache       # Search for cache-related commands
#   pkgcheat -e npm         # Export npm cheatsheet to markdown
################################################################################

set -e

# Script metadata
SCRIPT_VERSION="1.0.0"
SCRIPT_NAME="pkgcheat"

# ANSI color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
RESET='\033[0m'

# Detected package managers (will be populated)
declare -a DETECTED_MANAGERS=()
declare -a DETECTED_VERSIONS=()
declare -a DETECTED_PATHS=()
declare -a DETECTED_CATEGORIES=()

################################################################################
# Package Manager Definitions
################################################################################

# All supported package managers by category
PM_JAVASCRIPT=("npm" "pnpm" "yarn" "bun")
PM_MACOS=("brew" "port")
PM_PYTHON=("pip" "uv" "poetry")
PM_OTHER=("cargo" "go" "gem")

################################################################################
# Cheatsheet Data Structures
# Format: "key|command|description"
################################################################################

# npm commands
npm_commands=(
    "install|npm install <package>|Install a package locally"
    "install_global|npm install -g <package>|Install a package globally"
    "install_dev|npm install --save-dev <package>|Install as dev dependency"
    "install_all|npm install|Install all dependencies from package.json"
    "update|npm update|Update all packages"
    "update_global|npm update -g|Update all global packages"
    "update_package|npm update <package>|Update specific package"
    "remove|npm uninstall <package>|Remove a package"
    "remove_global|npm uninstall -g <package>|Remove global package"
    "list|npm list|List installed packages"
    "list_global|npm list -g --depth=0|List global packages"
    "search|npm search <package>|Search for packages"
    "info|npm view <package>|Show package information"
    "cache_clean|npm cache clean --force|Clear npm cache"
    "outdated|npm outdated|Check for outdated packages"
    "audit|npm audit|Run security audit"
    "audit_fix|npm audit fix|Fix security vulnerabilities"
    "init|npm init|Initialize new project"
    "run|npm run <script>|Run package.json script"
    "link|npm link|Create symlink for local development"
)

# pnpm commands
pnpm_commands=(
    "install|pnpm add <package>|Install a package locally"
    "install_global|pnpm add -g <package>|Install a package globally"
    "install_dev|pnpm add -D <package>|Install as dev dependency"
    "install_all|pnpm install|Install all dependencies from package.json"
    "update|pnpm update|Update all packages"
    "update_global|pnpm update -g|Update all global packages"
    "update_package|pnpm update <package>|Update specific package"
    "remove|pnpm remove <package>|Remove a package"
    "remove_global|pnpm remove -g <package>|Remove global package"
    "list|pnpm list|List installed packages"
    "list_global|pnpm list -g|List global packages"
    "search|pnpm search <package>|Search for packages (via npm registry)"
    "info|pnpm view <package>|Show package information"
    "cache_clean|pnpm store prune|Clear pnpm store/cache"
    "outdated|pnpm outdated|Check for outdated packages"
    "audit|pnpm audit|Run security audit"
    "audit_fix|pnpm audit --fix|Fix security vulnerabilities"
    "init|pnpm init|Initialize new project"
    "run|pnpm run <script>|Run package.json script"
    "link|pnpm link|Create symlink for local development"
)

# yarn commands
yarn_commands=(
    "install|yarn add <package>|Install a package locally"
    "install_global|yarn global add <package>|Install a package globally"
    "install_dev|yarn add -D <package>|Install as dev dependency"
    "install_all|yarn install|Install all dependencies from yarn.lock"
    "update|yarn upgrade|Update all packages"
    "update_global|yarn global upgrade|Update all global packages"
    "update_package|yarn upgrade <package>|Update specific package"
    "update_interactive|yarn upgrade-interactive|Interactive package update"
    "remove|yarn remove <package>|Remove a package"
    "remove_global|yarn global remove <package>|Remove global package"
    "list|yarn list|List installed packages"
    "list_global|yarn global list|List global packages"
    "search|yarn search <package>|Search for packages (via npm registry)"
    "info|yarn info <package>|Show package information"
    "cache_clean|yarn cache clean|Clear yarn cache"
    "outdated|yarn outdated|Check for outdated packages"
    "audit|yarn audit|Run security audit"
    "audit_fix|yarn audit --fix|Fix security vulnerabilities"
    "init|yarn init|Initialize new project"
    "run|yarn run <script>|Run package.json script"
    "link|yarn link|Create symlink for local development"
)

# bun commands
bun_commands=(
    "install|bun add <package>|Install a package locally"
    "install_global|bun add -g <package>|Install a package globally"
    "install_dev|bun add -d <package>|Install as dev dependency"
    "install_all|bun install|Install all dependencies from package.json"
    "update|bun update|Update all packages"
    "update_package|bun update <package>|Update specific package"
    "remove|bun remove <package>|Remove a package"
    "list|bun pm ls|List installed packages"
    "list_global|bun pm ls -g|List global packages"
    "info|bun pm <package>|Show package information"
    "cache_clean|bun pm cache|Show cache location"
    "cache_rm|bun pm cache rm|Remove cache"
    "outdated|bun outdated|Check for outdated packages"
    "init|bun init|Initialize new project"
    "run|bun run <script>|Run package.json script"
)

# brew commands
brew_commands=(
    "install|brew install <package>|Install a package"
    "install_cask|brew install --cask <app>|Install GUI application"
    "update_self|brew update|Update Homebrew itself"
    "upgrade|brew upgrade|Upgrade all packages"
    "upgrade_package|brew upgrade <package>|Upgrade specific package"
    "remove|brew uninstall <package>|Remove a package"
    "autoremove|brew autoremove|Remove unused dependencies"
    "list|brew list|List installed packages"
    "info|brew info <package>|Show package information"
    "search|brew search <package>|Search for packages"
    "cleanup|brew cleanup|Remove old versions"
    "cleanup_all|brew cleanup --prune=all|Remove all old downloads"
    "outdated|brew outdated|Check for outdated packages"
    "doctor|brew doctor|Diagnose Homebrew issues"
    "services|brew services list|List services"
)

# port commands
port_commands=(
    "install|sudo port install <package>|Install a package"
    "install_yes|sudo port install -y <package>|Install without prompts"
    "update_self|sudo port selfupdate|Update MacPorts itself"
    "upgrade|sudo port upgrade outdated|Upgrade all packages"
    "upgrade_package|sudo port upgrade <package>|Upgrade specific package"
    "remove|sudo port uninstall <package>|Remove a package"
    "remove_inactive|sudo port uninstall inactive|Remove old versions"
    "list|port installed|List installed packages"
    "info|port info <package>|Show package information"
    "search|port search <package>|Search for packages"
    "clean|sudo port clean --all <package>|Clean build files"
    "reclaim|sudo port reclaim|Reclaim disk space"
    "outdated|port outdated|Check for outdated packages"
)

# pip commands
pip_commands=(
    "install|pip install <package>|Install a package"
    "install_upgrade|pip install -U <package>|Install or upgrade package"
    "install_requirements|pip install -r requirements.txt|Install from requirements"
    "upgrade_pip|pip install --upgrade pip|Upgrade pip itself"
    "remove|pip uninstall <package>|Remove a package"
    "list|pip list|List installed packages"
    "info|pip show <package>|Show package information"
    "search|pip search <package>|Search for packages (deprecated)"
    "cache_purge|pip cache purge|Clear pip cache"
    "outdated|pip list --outdated|Check for outdated packages"
    "check|pip check|Verify dependencies"
    "freeze|pip freeze > requirements.txt|Export dependencies"
)

# uv commands
uv_commands=(
    "install|uv pip install <package>|Install a package"
    "install_upgrade|uv pip install -U <package>|Install or upgrade package"
    "install_requirements|uv pip install -r requirements.txt|Install from requirements"
    "remove|uv pip uninstall <package>|Remove a package"
    "list|uv pip list|List installed packages"
    "info|uv pip show <package>|Show package information"
    "search|uv pip search <package>|Search for packages"
    "cache_clean|uv cache clean|Clear uv cache"
    "freeze|uv pip freeze|Export dependencies"
    "sync|uv pip sync requirements.txt|Sync to exact requirements"
)

# poetry commands
poetry_commands=(
    "install|poetry add <package>|Install a package"
    "install_dev|poetry add -D <package>|Install as dev dependency"
    "install_all|poetry install|Install all dependencies from lock file"
    "update|poetry update|Update all packages"
    "update_package|poetry update <package>|Update specific package"
    "remove|poetry remove <package>|Remove a package"
    "list|poetry show|List installed packages"
    "list_tree|poetry show --tree|List with dependency tree"
    "info|poetry show <package>|Show package information"
    "search|poetry search <package>|Search for packages"
    "cache_clear|poetry cache clear --all pypi|Clear poetry cache"
    "outdated|poetry show --outdated|Check for outdated packages"
    "init|poetry init|Initialize new project"
    "run|poetry run <command>|Run command in virtual environment"
    "shell|poetry shell|Activate virtual environment"
)

# cargo commands
cargo_commands=(
    "install|cargo install <package>|Install a binary package"
    "install_locked|cargo install --locked <package>|Install with locked versions"
    "update|cargo update|Update all dependencies"
    "remove|cargo uninstall <package>|Remove a binary package"
    "list|cargo install --list|List installed binaries"
    "search|cargo search <package>|Search for packages"
    "info|cargo info <package>|Show package information"
    "clean|cargo clean|Remove build artifacts"
    "outdated|cargo outdated|Check for outdated deps (requires cargo-outdated)"
    "init|cargo init|Initialize new project"
    "new|cargo new <name>|Create new project"
    "build|cargo build|Build project"
    "run|cargo run|Run project"
    "test|cargo test|Run tests"
)

# go commands
go_commands=(
    "install|go install <package>@latest|Install a package"
    "install_version|go install <package>@<version>|Install specific version"
    "get|go get <package>|Download and install package"
    "update|go get -u <package>|Update specific package"
    "update_all|go get -u all|Update all dependencies"
    "list|go list -m all|List all modules"
    "list_versions|go list -m -versions <package>|List available versions"
    "cache_clean|go clean -modcache|Clear module cache"
    "init|go mod init <module>|Initialize new module"
    "tidy|go mod tidy|Add missing and remove unused modules"
    "download|go mod download|Download modules to cache"
    "verify|go mod verify|Verify dependencies"
    "build|go build|Build project"
    "run|go run .|Run project"
    "test|go test ./...|Run all tests"
)

# gem commands
gem_commands=(
    "install|gem install <gem>|Install a gem"
    "install_version|gem install <gem> -v <version>|Install specific version"
    "update|gem update|Update all gems"
    "update_gem|gem update <gem>|Update specific gem"
    "update_system|gem update --system|Update RubyGems itself"
    "remove|gem uninstall <gem>|Remove a gem"
    "list|gem list|List installed gems"
    "info|gem info <gem>|Show gem information"
    "search|gem search <gem>|Search for gems"
    "cleanup|gem cleanup|Remove old versions"
    "outdated|gem outdated|Check for outdated gems"
    "pristine|gem pristine <gem>|Restore gem to pristine condition"
    "environment|gem environment|Show RubyGems environment"
)

################################################################################
# Helper Functions
################################################################################

# Print colored output
print_color() {
    local color=$1
    shift
    echo -e "${color}$*${RESET}"
}

# Get list command for a package manager
get_list_command() {
    local pm=$1
    local array_name="${pm}_commands[@]"

    # Validate that the array exists
    if [[ -z "${!array_name+x}" ]]; then
        echo ""
        return 1
    fi

    local commands=("${!array_name}")

    # Check if list_global exists
    for cmd_entry in "${commands[@]}"; do
        IFS='|' read -r key command description <<< "$cmd_entry"
        if [[ "$key" == "list_global" ]]; then
            echo "$command"
            return 0
        fi
    done

    # If no list_global, use list
    for cmd_entry in "${commands[@]}"; do
        IFS='|' read -r key command description <<< "$cmd_entry"
        if [[ "$key" == "list" ]]; then
            echo "$command"
            return 0
        fi
    done

    # No list command found
    echo ""
    return 1
}

# Print header
print_header() {
    echo ""
    print_color "$BOLD$MAGENTA" "═══════════════════════════════════════════════════════════════"
    print_color "$BOLD$MAGENTA" "  $1"
    print_color "$BOLD$MAGENTA" "═══════════════════════════════════════════════════════════════"
    echo ""
}

# Print section
print_section() {
    echo ""
    print_color "$BOLD$CYAN" "─── $1 ───"
    echo ""
}

# Check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Get package manager version
get_version() {
    local pm=$1
    local version="unknown"

    case "$pm" in
        npm|pnpm|yarn|bun)
            version=$("$pm" --version 2>/dev/null || echo "unknown")
            ;;
        brew)
            version=$(brew --version 2>/dev/null | head -1 | awk '{print $2}' || echo "unknown")
            ;;
        port)
            version=$(port version 2>/dev/null | awk '{print $2}' || echo "unknown")
            ;;
        pip)
            version=$(pip --version 2>/dev/null | awk '{print $2}' || echo "unknown")
            ;;
        uv)
            version=$(uv --version 2>/dev/null | awk '{print $2}' || echo "unknown")
            ;;
        poetry)
            version=$(poetry --version 2>/dev/null | awk '{print $3}' || echo "unknown")
            ;;
        cargo)
            version=$(cargo --version 2>/dev/null | awk '{print $2}' || echo "unknown")
            ;;
        go)
            version=$(go version 2>/dev/null | awk '{print $3}' | sed 's/go//' || echo "unknown")
            ;;
        gem)
            version=$(gem --version 2>/dev/null || echo "unknown")
            ;;
    esac

    echo "$version"
}

# Get category for package manager
get_category() {
    local pm=$1

    for manager in "${PM_JAVASCRIPT[@]}"; do
        if [[ "$manager" == "$pm" ]]; then
            echo "JavaScript/Node.js"
            return
        fi
    done

    for manager in "${PM_MACOS[@]}"; do
        if [[ "$manager" == "$pm" ]]; then
            echo "macOS System"
            return
        fi
    done

    for manager in "${PM_PYTHON[@]}"; do
        if [[ "$manager" == "$pm" ]]; then
            echo "Python"
            return
        fi
    done

    for manager in "${PM_OTHER[@]}"; do
        if [[ "$manager" == "$pm" ]]; then
            case "$pm" in
                cargo) echo "Rust" ;;
                go) echo "Go" ;;
                gem) echo "Ruby" ;;
            esac
            return
        fi
    done
}

################################################################################
# Detection Engine
################################################################################

detect_package_managers() {
    print_header "Detecting Package Managers..."

    local all_managers=("${PM_JAVASCRIPT[@]}" "${PM_MACOS[@]}" "${PM_PYTHON[@]}" "${PM_OTHER[@]}")

    for pm in "${all_managers[@]}"; do
        if command_exists "$pm"; then
            local version=$(get_version "$pm")
            local path=$(command -v "$pm")
            local category=$(get_category "$pm")

            DETECTED_MANAGERS+=("$pm")
            DETECTED_VERSIONS+=("$version")
            DETECTED_PATHS+=("$path")
            DETECTED_CATEGORIES+=("$category")

            print_color "$GREEN" "✓ Found: $pm ($version)"
        fi
    done

    if [[ ${#DETECTED_MANAGERS[@]} -eq 0 ]]; then
        print_color "$RED" "✗ No package managers detected on this system!"
        return 1
    fi

    echo ""
    print_color "$BOLD$GREEN" "Total detected: ${#DETECTED_MANAGERS[@]} package manager(s)"
}

################################################################################
# Display Functions
################################################################################

# List all global packages across detected managers
list_all_globals() {
    print_header "Global Packages Across All Package Managers"

    for pm in "${DETECTED_MANAGERS[@]}"; do
        local list_cmd=$(get_list_command "$pm")

        if [[ -z "$list_cmd" ]]; then
            continue
        fi

        # Print manager section header with version
        local version=""
        for i in "${!DETECTED_MANAGERS[@]}"; do
            if [[ "${DETECTED_MANAGERS[$i]}" == "$pm" ]]; then
                version="${DETECTED_VERSIONS[$i]}"
                break
            fi
        done

        print_color "$BOLD$CYAN" "━━━ $pm ($version) ━━━"
        echo ""

        # Execute the list command and display output
        # Disable set -e temporarily to handle errors gracefully
        set +e
        local output=$($list_cmd 2>&1)
        local exit_code=$?
        set -e

        if [[ $exit_code -eq 0 ]] && [[ -n "$output" ]]; then
            echo "$output"
            echo ""
            print_color "$GREEN" "✓ Listed successfully"
        elif [[ -z "$output" ]]; then
            print_color "$YELLOW" "⚠ No packages installed globally"
        else
            print_color "$RED" "✗ Command failed or not applicable"
            if [[ -n "$output" ]]; then
                echo "$output" | head -3
            fi
        fi

        echo ""
        print_color "$CYAN" "────────────────────────────────────────────────────────"
        echo ""
    done

    print_color "$BOLD$GREEN" "✓ Listing complete!"
    echo ""
    read -p "Press Enter to continue..."
}

display_summary() {
    print_header "Detected Package Managers"

    # Group by category
    local current_category=""

    for i in "${!DETECTED_MANAGERS[@]}"; do
        local category="${DETECTED_CATEGORIES[$i]}"

        if [[ "$category" != "$current_category" ]]; then
            print_color "$BOLD$MAGENTA" "[$category]"
            current_category="$category"
        fi

        printf "${GREEN}  %-12s${RESET} ${YELLOW}%-15s${RESET} ${CYAN}%s${RESET}\n" \
            "${DETECTED_MANAGERS[$i]}" \
            "${DETECTED_VERSIONS[$i]}" \
            "${DETECTED_PATHS[$i]}"
    done

    echo ""
}

display_cheatsheet() {
    local pm=$1

    # Check if manager is detected
    local found=false
    for detected in "${DETECTED_MANAGERS[@]}"; do
        if [[ "$detected" == "$pm" ]]; then
            found=true
            break
        fi
    done

    if [[ "$found" == false ]]; then
        print_color "$RED" "Package manager '$pm' not detected on this system!"
        return 1
    fi

    # Get commands array for this package manager
    local array_name="${pm}_commands[@]"
    local commands=("${!array_name}")

    if [[ ${#commands[@]} -eq 0 ]]; then
        print_color "$RED" "No cheatsheet available for '$pm'"
        return 1
    fi

    print_header "$pm Cheatsheet"

    # Print table header
    printf "${BOLD}%-20s %-50s %-30s${RESET}\n" "Operation" "Command" "Description"
    print_color "$CYAN" "────────────────────────────────────────────────────────────────────────────────────────────────────"

    # Print commands
    for cmd_entry in "${commands[@]}"; do
        IFS='|' read -r key command description <<< "$cmd_entry"
        printf "${YELLOW}%-20s${RESET} ${BLUE}%-50s${RESET} ${CYAN}%-30s${RESET}\n" \
            "$key" "$command" "$description"
    done

    echo ""
}

display_comparison() {
    local operation=$1

    print_header "Command Comparison: $operation"

    # Common operations to compare
    local js_managers=("npm" "pnpm" "yarn" "bun")

    printf "${BOLD}%-12s %-60s${RESET}\n" "Manager" "Command"
    print_color "$CYAN" "────────────────────────────────────────────────────────────────────────"

    for pm in "${js_managers[@]}"; do
        # Check if detected
        local detected=false
        for d in "${DETECTED_MANAGERS[@]}"; do
            if [[ "$d" == "$pm" ]]; then
                detected=true
                break
            fi
        done

        if [[ "$detected" == false ]]; then
            continue
        fi

        # Get command for this operation
        local array_name="${pm}_commands[@]"
        local commands=("${!array_name}")

        for cmd_entry in "${commands[@]}"; do
            IFS='|' read -r key command description <<< "$cmd_entry"
            if [[ "$key" == "$operation" ]]; then
                printf "${GREEN}%-12s${RESET} ${BLUE}%-60s${RESET}\n" "$pm" "$command"
                break
            fi
        done
    done

    echo ""
}

search_commands() {
    local keyword=$1

    print_header "Search Results for: $keyword"

    local found_count=0

    for pm in "${DETECTED_MANAGERS[@]}"; do
        local array_name="${pm}_commands[@]"
        local commands=("${!array_name}")
        local pm_found=false

        for cmd_entry in "${commands[@]}"; do
            IFS='|' read -r key command description <<< "$cmd_entry"

            # Case-insensitive search in key, command, and description
            if [[ "$key" =~ $keyword ]] || \
               [[ "$command" =~ $keyword ]] || \
               [[ "$description" =~ $keyword ]]; then

                if [[ "$pm_found" == false ]]; then
                    print_color "$BOLD$MAGENTA" "[$pm]"
                    pm_found=true
                fi

                printf "  ${YELLOW}%-20s${RESET} ${BLUE}%-45s${RESET} ${CYAN}%s${RESET}\n" \
                    "$key" "$command" "$description"
                ((found_count++))
            fi
        done

        if [[ "$pm_found" == true ]]; then
            echo ""
        fi
    done

    if [[ $found_count -eq 0 ]]; then
        print_color "$RED" "No commands found matching '$keyword'"
    else
        print_color "$GREEN" "Found $found_count matching command(s)"
    fi

    echo ""
}

################################################################################
# Export Functionality
################################################################################

export_cheatsheet() {
    local pm=$1
    local export_all=false

    if [[ -z "$pm" ]] || [[ "$pm" == "all" ]]; then
        export_all=true
    fi

    local timestamp=$(date +%Y%m%d_%H%M%S)
    local filename

    if [[ "$export_all" == true ]]; then
        filename="$HOME/pkgcheat-export-all-${timestamp}.md"
    else
        filename="$HOME/pkgcheat-export-${pm}-${timestamp}.md"
    fi

    print_header "Exporting Cheatsheet(s)"

    {
        echo "# Package Manager Cheatsheet"
        echo ""
        echo "Generated on: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "Script Version: $SCRIPT_VERSION"
        echo ""
        echo "---"
        echo ""

        if [[ "$export_all" == true ]]; then
            # Export all detected managers
            for pm_name in "${DETECTED_MANAGERS[@]}"; do
                export_single_manager_md "$pm_name"
            done
        else
            # Export single manager
            export_single_manager_md "$pm"
        fi

    } > "$filename"

    if [[ $? -eq 0 ]]; then
        print_color "$GREEN" "✓ Exported successfully!"
        print_color "$CYAN" "File: $filename"
        echo ""
    else
        print_color "$RED" "✗ Export failed!"
    fi
}

export_single_manager_md() {
    local pm=$1

    # Get manager info
    local version=""
    local path=""

    for i in "${!DETECTED_MANAGERS[@]}"; do
        if [[ "${DETECTED_MANAGERS[$i]}" == "$pm" ]]; then
            version="${DETECTED_VERSIONS[$i]}"
            path="${DETECTED_PATHS[$i]}"
            break
        fi
    done

    echo "## $pm"
    echo ""
    echo "**Version:** $version"
    echo ""
    echo "**Path:** \`$path\`"
    echo ""

    # Get commands
    local array_name="${pm}_commands[@]"
    local commands=("${!array_name}")

    echo "### Commands"
    echo ""
    echo "| Operation | Command | Description |"
    echo "|-----------|---------|-------------|"

    for cmd_entry in "${commands[@]}"; do
        IFS='|' read -r key command description <<< "$cmd_entry"
        echo "| $key | \`$command\` | $description |"
    done

    echo ""
    echo "---"
    echo ""
}

################################################################################
# Interactive Menu
################################################################################

show_main_menu() {
    while true; do
        clear
        print_header "Package Manager Cheatsheet - Main Menu"

        echo "Select an option:"
        echo ""
        print_color "$CYAN" "  1) Show detected package managers"
        print_color "$CYAN" "  2) View cheatsheet for a manager"
        print_color "$CYAN" "  3) Compare managers side-by-side"
        print_color "$CYAN" "  4) Search for commands"
        print_color "$CYAN" "  5) Export cheatsheet to markdown"
        print_color "$CYAN" "  6) Help / Usage information"
        print_color "$CYAN" "  7) List all global packages"
        print_color "$CYAN" "  8) Exit"
        echo ""

        read -p "Enter your choice [1-8]: " choice

        case $choice in
            1)
                clear
                display_summary
                read -p "Press Enter to continue..."
                ;;
            2)
                clear
                menu_select_manager
                ;;
            3)
                clear
                menu_compare_managers
                ;;
            4)
                clear
                menu_search_commands
                ;;
            5)
                clear
                menu_export_cheatsheet
                ;;
            6)
                clear
                show_help
                read -p "Press Enter to continue..."
                ;;
            7)
                clear
                list_all_globals
                ;;
            8)
                print_color "$GREEN" "Thank you for using pkgcheat!"
                exit 0
                ;;
            *)
                print_color "$RED" "Invalid choice. Please try again."
                sleep 1
                ;;
        esac
    done
}

menu_select_manager() {
    print_header "Select Package Manager"

    echo "Available package managers:"
    echo ""

    for i in "${!DETECTED_MANAGERS[@]}"; do
        local num=$((i + 1))
        printf "  ${CYAN}%2d)${RESET} ${GREEN}%-10s${RESET} ${YELLOW}(%s)${RESET}\n" \
            "$num" "${DETECTED_MANAGERS[$i]}" "${DETECTED_VERSIONS[$i]}"
    done

    echo ""
    read -p "Select a manager (1-${#DETECTED_MANAGERS[@]}) or 0 to cancel: " choice

    if [[ "$choice" -ge 1 ]] && [[ "$choice" -le ${#DETECTED_MANAGERS[@]} ]]; then
        local index=$((choice - 1))
        local pm="${DETECTED_MANAGERS[$index]}"
        clear
        display_cheatsheet "$pm"
        read -p "Press Enter to continue..."
    elif [[ "$choice" == "0" ]]; then
        return
    else
        print_color "$RED" "Invalid choice."
        sleep 1
    fi
}

menu_compare_managers() {
    print_header "Compare JavaScript Package Managers"

    echo "Select operation to compare:"
    echo ""
    print_color "$CYAN" "  1) install - Install a package"
    print_color "$CYAN" "  2) install_global - Install globally"
    print_color "$CYAN" "  3) install_dev - Install dev dependency"
    print_color "$CYAN" "  4) update - Update all packages"
    print_color "$CYAN" "  5) remove - Remove a package"
    print_color "$CYAN" "  6) list - List installed packages"
    print_color "$CYAN" "  7) cache_clean - Clear cache"
    print_color "$CYAN" "  8) outdated - Check outdated packages"
    print_color "$CYAN" "  0) Cancel"
    echo ""

    read -p "Enter your choice: " choice

    case $choice in
        1) display_comparison "install" ;;
        2) display_comparison "install_global" ;;
        3) display_comparison "install_dev" ;;
        4) display_comparison "update" ;;
        5) display_comparison "remove" ;;
        6) display_comparison "list" ;;
        7) display_comparison "cache_clean" ;;
        8) display_comparison "outdated" ;;
        0) return ;;
        *) print_color "$RED" "Invalid choice." ; sleep 1 ; return ;;
    esac

    read -p "Press Enter to continue..."
}

menu_search_commands() {
    print_header "Search Commands"

    read -p "Enter search keyword: " keyword

    if [[ -n "$keyword" ]]; then
        clear
        search_commands "$keyword"
        read -p "Press Enter to continue..."
    fi
}

menu_export_cheatsheet() {
    print_header "Export Cheatsheet"

    echo "Export options:"
    echo ""
    print_color "$CYAN" "  1) Export all detected managers"
    print_color "$CYAN" "  2) Export specific manager"
    print_color "$CYAN" "  0) Cancel"
    echo ""

    read -p "Enter your choice: " choice

    case $choice in
        1)
            export_cheatsheet "all"
            read -p "Press Enter to continue..."
            ;;
        2)
            echo ""
            for i in "${!DETECTED_MANAGERS[@]}"; do
                local num=$((i + 1))
                printf "  ${CYAN}%2d)${RESET} ${GREEN}%s${RESET}\n" "$num" "${DETECTED_MANAGERS[$i]}"
            done
            echo ""
            read -p "Select a manager (1-${#DETECTED_MANAGERS[@]}): " pm_choice

            if [[ "$pm_choice" -ge 1 ]] && [[ "$pm_choice" -le ${#DETECTED_MANAGERS[@]} ]]; then
                local index=$((pm_choice - 1))
                local pm="${DETECTED_MANAGERS[$index]}"
                export_cheatsheet "$pm"
                read -p "Press Enter to continue..."
            else
                print_color "$RED" "Invalid choice."
                sleep 1
            fi
            ;;
        0)
            return
            ;;
        *)
            print_color "$RED" "Invalid choice."
            sleep 1
            ;;
    esac
}

################################################################################
# Help and Usage
################################################################################

show_help() {
    print_header "Package Manager Cheatsheet - Help"

    echo -e "${BOLD}USAGE:${RESET}"
    echo "  pkgcheat [OPTIONS] [MANAGER]"
    echo ""
    echo -e "${BOLD}OPTIONS:${RESET}"
    echo "  -h, --help              Show this help message"
    echo "  -v, --version           Show script version"
    echo "  -l, --list              List detected package managers"
    echo "  -a, --all               Show all supported managers (even not installed)"
    echo "  -e, --export [MANAGER]  Export cheatsheet to markdown file"
    echo "                          (omit MANAGER or use 'all' for all detected)"
    echo "  -s, --search KEYWORD    Search for commands across all managers"
    echo "  -c, --compare           Compare equivalent commands across JS managers"
    echo ""
    echo -e "${BOLD}ARTIFACT MANAGEMENT:${RESET}"
    echo "  --artifacts [PATH]      List all project artifacts (node_modules, .venv, etc.)"
    echo "  --artifacts-node [PATH] List node_modules directories only"
    echo "  --artifacts-python [PATH] List Python virtual environments only"
    echo ""
    echo -e "${BOLD}EXAMPLES:${RESET}"
    echo "  pkgcheat                # Launch interactive mode"
    echo "  pkgcheat npm            # Show npm cheatsheet directly"
    echo "  pkgcheat -l             # List all detected package managers"
    echo "  pkgcheat -s cache       # Search for cache-related commands"
    echo "  pkgcheat -e npm         # Export npm cheatsheet to markdown"
    echo "  pkgcheat -e all         # Export all detected managers to markdown"
    echo "  pkgcheat -c             # Show command comparison"
    echo "  pkgcheat --artifacts .  # List all artifacts in current directory"
    echo "  pkgcheat --artifacts-node ~/Projects  # List node_modules in ~/Projects"
    echo "  pkgcheat --artifacts-python .         # List Python venvs in current directory"
    echo ""
    echo -e "${BOLD}SUPPORTED PACKAGE MANAGERS:${RESET}"
    echo "  JavaScript/Node.js:  npm, pnpm, yarn, bun"
    echo "  macOS System:        brew, port"
    echo "  Python:              pip, uv, poetry"
    echo "  Other Languages:     cargo (Rust), go (Go), gem (Ruby)"
    echo ""
    echo -e "${BOLD}INTERACTIVE MODE:${RESET}"
    echo "  When run without arguments, pkgcheat launches an interactive menu where you can:"
    echo "    - View detected package managers"
    echo "    - Browse cheatsheets for each manager"
    echo "    - Compare commands across managers"
    echo "    - Search for specific commands"
    echo "    - Export cheatsheets to markdown files"
    echo ""
    echo -e "${BOLD}VERSION:${RESET}"
    echo "  $SCRIPT_VERSION"
    echo ""
    echo -e "${BOLD}REPOSITORY:${RESET}"
    echo "  https://github.com/RamonLiao/package-cheat"
    echo ""
}

show_version() {
    echo "$SCRIPT_NAME version $SCRIPT_VERSION"
}

show_all_managers() {
    print_header "All Supported Package Managers"

    local all_managers=("${PM_JAVASCRIPT[@]}" "${PM_MACOS[@]}" "${PM_PYTHON[@]}" "${PM_OTHER[@]}")

    echo "Legend: ${GREEN}✓ Installed${RESET} | ${RED}✗ Not installed${RESET}"
    echo ""

    for pm in "${all_managers[@]}"; do
        local category=$(get_category "$pm")
        local detected=false

        for d in "${DETECTED_MANAGERS[@]}"; do
            if [[ "$d" == "$pm" ]]; then
                detected=true
                break
            fi
        done

        if [[ "$detected" == true ]]; then
            printf "${GREEN}✓${RESET} %-12s ${CYAN}(%s)${RESET}\n" "$pm" "$category"
        else
            printf "${RED}✗${RESET} %-12s ${CYAN}(%s)${RESET}\n" "$pm" "$category"
        fi
    done

    echo ""
}

################################################################################
# Artifact Discovery Functions
################################################################################

# Get script directory for calling standalone scripts
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Run artifacts scripts
run_artifacts_all() {
    local path="${1:-.}"
    "${SCRIPT_DIR}/../list-all-artifacts.sh" "$path"
}

run_artifacts_node() {
    local path="${1:-.}"
    "${SCRIPT_DIR}/../list-node-modules.sh" "$path"
}

run_artifacts_python() {
    local path="${1:-.}"
    "${SCRIPT_DIR}/../list-python-venvs.sh" "$path"
}

################################################################################
# Main Entry Point
################################################################################

main() {
    # Detect package managers first
    detect_package_managers

    # If no arguments, show interactive menu
    if [[ $# -eq 0 ]]; then
        show_main_menu
        return 0
    fi

    # Parse command-line arguments
    case "$1" in
        -h|--help)
            show_help
            ;;
        -v|--version)
            show_version
            ;;
        -l|--list)
            display_summary
            ;;
        -a|--all)
            show_all_managers
            ;;
        -e|--export)
            if [[ -n "$2" ]]; then
                export_cheatsheet "$2"
            else
                export_cheatsheet "all"
            fi
            ;;
        -s|--search)
            if [[ -z "$2" ]]; then
                print_color "$RED" "Error: Search keyword required"
                echo "Usage: pkgcheat -s KEYWORD"
                exit 1
            fi
            search_commands "$2"
            ;;
        -c|--compare)
            echo "Select operation to compare:"
            echo "  1) install"
            echo "  2) install_global"
            echo "  3) update"
            echo "  4) remove"
            echo "  5) cache_clean"
            read -p "Choice: " choice
            case $choice in
                1) display_comparison "install" ;;
                2) display_comparison "install_global" ;;
                3) display_comparison "update" ;;
                4) display_comparison "remove" ;;
                5) display_comparison "cache_clean" ;;
                *) print_color "$RED" "Invalid choice" ; exit 1 ;;
            esac
            ;;
        --artifacts)
            ARTIFACTS_PATH="${2:-.}"
            run_artifacts_all "$ARTIFACTS_PATH"
            ;;
        --artifacts-node)
            ARTIFACTS_PATH="${2:-.}"
            run_artifacts_node "$ARTIFACTS_PATH"
            ;;
        --artifacts-python)
            ARTIFACTS_PATH="${2:-.}"
            run_artifacts_python "$ARTIFACTS_PATH"
            ;;
        *)
            # Assume it's a package manager name
            display_cheatsheet "$1"
            ;;
    esac
}

# Run main function
main "$@"
